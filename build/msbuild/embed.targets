<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Things that work:
     -   - removing a generated .cpp file works (properly rebuilt)
     -   - modifying a generated .cpp file works (properly rebuilt)
     - Things that do not always work (FIXME):
     -   - modifying an embeded resource confuses FUTDC
     - Things that do not work (FIXME):
     -   - @(SelectedFiles) doesn’t work yet (compiling a single file from the IDE)
     -   - cleaning up is not implemented yet
     - Documentation:
     -   - MSBuild targets (VS2022): https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-targets?view=vs-2022
     -   - an interesting SO answer: https://stackoverflow.com/a/55895543/111461
   -->

  <!-- Tell the IDE how to display LolEmbed files -->
  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" />
  </ItemGroup>

  <!-- Tell the rest of the build system that our targets create compile inputs -->
  <PropertyGroup>
    <ComputeCompileInputsTargets>LolEmbed;BuildLolEmbedRegistry;$(ComputeCompileInputsTargets)</ComputeCompileInputsTargets>
  </PropertyGroup>

  <!-- Define a new target for embedded files, active only if there are LolEmbed items.
     - Make sure we run before “ClCompile” since we generate C++ files.
     - Also make sure we run after _SelectedFiles in case there are selected files in the IDE. -->
  <Target Name="LolEmbed" Condition="'@(LolEmbed)'!=''"
          BeforeTargets="ClCompile" DependsOnTargets="_SelectedFiles"
          Inputs="@(LolEmbed)" Outputs="@(LolEmbed-&gt;'%(CppFileName)')">

    <!-- If files are selected, do not compile the other ones. -->
    <ItemGroup Condition="'@(SelectedFiles)'!=''">
      <LolEmbed Remove="@(LolEmbed)" Condition="'%(Identity)'!='@(SelectedFiles)'" />
    </ItemGroup>

    <ItemGroup>
      <LolEmbed_tlog
        Include="%(LolEmbed.CppFileName)"
        Condition="'%(LolEmbed.CppFileName)'!='' and '%(LolEmbed.ExcludedFromBuild)'!='true'">
        <Source>@(LolEmbed, '|')</Source>
      </LolEmbed_tlog>
    </ItemGroup>

    <WriteLinesToFile Condition="'@(LolEmbed_tlog)'!='' and '%(LolEmbed_tlog.ExcludedFromBuild)'!='true'"
                      File="$(IntDir)$(ProjectName).write.1.tlog"
                      Lines="^%(LolEmbed_tlog.Source);@(LolEmbed_tlog-&gt;'%(Fullpath)')" />

    <!-- Compare input and output file date to decide whether to run the task.
       - This is not actually used, but may be necessary if the number of inputs
       - and outputs changes one day:
       - Condition="'@(LolEmbed)'!='' and $(SourceFileDate)>$(GeneratedFileDate)"
     -->
    <PropertyGroup Condition="'@(LolEmbed)'!=''">
      <SourceFileDate>$([System.DateTime]::Parse('%(LolEmbed.ModifiedTime)').Ticks)</SourceFileDate>
      <GeneratedFileDate Condition="!exists(%(LolEmbed.CppFileName.Identity))">0</GeneratedFileDate>
      <GeneratedFileDate Condition="exists(%(LolEmbed.CppFileName.Identity))">$([System.DateTime]::Parse('%(LolEmbed.CppFileName.ModifiedTime)').Ticks)</GeneratedFileDate>
    </PropertyGroup>

    <!-- Execute the actual LolEmbed task -->
    <LolEmbedTask Inputs="%(LolEmbed.Identity)" CppFileName="%(LolEmbed.CppFileName)" />

    <Message Importance="High" Text="%(LolEmbed.ExecutionDescription)" />

    <!-- Add generated files to the ClCompile item group, and make sure to tweak
       - ObjectFileName, otherwise we risk creating .obj files outside the intermediate
       - file directory because of ".." in paths. -->
    <ItemGroup>
      <ClCompile Include="%(LolEmbed.CppFileName)">
        <ObjectFileName>%(LolEmbed.ObjFileName)</ObjectFileName>
      </ClCompile>
    </ItemGroup>

  </Target>

  <!-- Tell Visual Studio’s fast up-to-date check (FUTDC) that embedded files need to
     - be considered when computing the up-to-date status. XXX: the leading semicolon
     - has to be there, for a completely unknown reason, otherwise VS2022 will always
     - treat the items as up-to-date.
     - It is also important that this happens _after_ the item definitions, because I
     - could not find a target that gets executed in time for FUTDC to use it.
     - FIXME: this does not always work; most of the time FUTDC says that everything
     - is up-to-date even though we just touched a file. -->
  <ItemGroup>
    <UpToDateCheckInput Include=";@(LolEmbed)" />
  </ItemGroup>

  <!-- Create a registry in the form of a .cpp file that references all embeds. -->
  <PropertyGroup>
    <LolEmbedRegistry>$(IntDir)embedded_registry</LolEmbedRegistry>
  </PropertyGroup>

  <Target Name="BuildLolEmbedRegistry" BeforeTargets="ClCompile" DependsOnTargets="LolEmbed"
          Outputs="$(LolEmbedRegistry).manifest;$(LolEmbedRegistry).g.cpp">

    <ReadLinesFromFile File="$(LolEmbedRegistry).manifest">
      <Output TaskParameter="Lines" ItemName="OldLolEmbed"/>
    </ReadLinesFromFile>

    <LolEmbedRegistryTask Condition="'@(OldLolEmbed)'!='@(LolEmbed)' or !exists('$(LolEmbedRegistry).g.cpp')"
                          RegistryFile="$(LolEmbedRegistry).g.cpp" Items="@(Lolembed)" />

    <Message Condition="'@(OldLolEmbed)'!='@(LolEmbed)' or !exists('$(LolEmbedRegistry).g.cpp')"
             Importance="High" Text="Creating $(LolEmbedRegistry).g.cpp" />

    <WriteLinesToFile Condition="'@(OldLolEmbed)'!='@(LolEmbed)' or !exists('$(LolEmbedRegistry).manifest')"
                      File="$(LolEmbedRegistry).manifest" Lines="@(Lolembed)" Overwrite="true" />

    <ItemGroup>
      <ClCompile Include="$(LolEmbedRegistry).g.cpp">
        <ObjectFileName>$(LolEmbedRegistry).g.obj</ObjectFileName>
      </ClCompile>
    </ItemGroup>

  </Target>

  <!-- Ensure the registry source file is cleaned up -->
  <Target Name="CleanLolEmbedRegistry" AfterTargets="Clean">
    <Delete Files="$(LolEmbedRegistry).manifest;$(LolEmbedRegistry).g.cpp" />
  </Target>

</Project>
