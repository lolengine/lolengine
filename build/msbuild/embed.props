<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="'$(LolEmbedBeforeTargets)'=='' and '$(LolEmbedAfterTargets)'==''">
    <LolEmbedBeforeTargets>Midl</LolEmbedBeforeTargets>
    <LolEmbedAfterTargets>CustomBuild</LolEmbedAfterTargets>
  </PropertyGroup>
  <PropertyGroup>
    <LolEmbedDependsOn>_SelectedFiles;$(LolEmbedDependsOn)</LolEmbedDependsOn>
    <PowerShellExe Condition="'$(PowerShellExe)'==''">%WINDIR%\System32\WindowsPowerShell\v1.0\powershell.exe</PowerShellExe>
  </PropertyGroup>
  <ItemDefinitionGroup>
    <LolEmbed>
      <CommandLineTemplate>@echo off
set D=$(IntDir)%(Filename)%(Extension).cpp

<!-- Replace \ with / in original filename so that it can be put in a C string -->
set "orig=%(RelativeDir)%(Filename)%(Extension)"
set "orig=%orig:\=/%"

<!-- COnvert file name to a C/C++ identifier (FIXME: not good enough) -->
set "name=lol_resource_%orig%"
set "name=%name:/=_%"
set "name=%name:-=_%"
set "name=%name:.=_%"

echo // WARNING! This file was autogenerated. DO NOT MODIFY IT!&gt; "%D%"
echo // See $(MSBuildThisFileFullpath) for more information.&gt;&gt; "%D%"
echo:&gt;&gt; "%D%"
echo #include ^&lt;cstdint^&gt; // for uint8_t&gt;&gt; "%D%"
echo #include ^&lt;cstddef^&gt; // for size_t&gt;&gt; "%D%"
echo:&gt;&gt; "%D%"
echo extern "C" {&gt;&gt; "%D%"
echo:&gt;&gt; "%D%"
echo uint8_t %name%[] {&gt;&gt; "%D%"

<!-- Dump file and format it as hex bytes, a bit like "xxd -i" would do. -->
$(PowerShellExe) -noninteractive -command ^
    "format-hex '%(Fullpath)' | " ^
    "foreach-object { '    0x' + ($_ -split '   *')[1].replace(' ', ', 0x') + ',' }" ^
    &gt;&gt; "%D%"

echo };&gt;&gt; "%D%"
echo:&gt;&gt; "%D%"
echo size_t %name%_size = sizeof(%name%);&gt;&gt; "%D%"
echo char const * %name%_path = "%orig%";&gt;&gt; "%D%"
echo:&gt;&gt; "%D%"
echo } // extern "C"&gt;&gt; "%D%"
        </CommandLineTemplate>
      <Outputs>$(IntDir)%(FileName)%(Extension).cpp</Outputs>
      <ExecutionDescription>%(FileName)%(Extension)</ExecutionDescription>
    </LolEmbed>
  </ItemDefinitionGroup>
</Project>
